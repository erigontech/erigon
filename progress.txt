[STEP] Reading flaky_test_commands.txt
[STEP] Analyzing flaky_test_commands.txt - the action is tests-linux (ubuntu-latest) which maps to ci.yml workflow
[FOUND] Key CI steps: make all (build), reproducible build test, make test-short
[STEP] Also includes test-integration-caplin.yml (spectest) and test-all-erigon-race.yml
[FOUND] The flaky action "tests-linux (ubuntu-latest)" most likely maps to ci.yml since it runs on ubuntu-latest
[STEP] Searching for CI workflow files
[STEP] Reading .github/workflows/ci.yml
[FOUND] ci.yml has a "linux" job with matrix os: [ubuntu-latest, macos-latest]. The flaky action is "tests-linux (ubuntu-latest)"
[FOUND] The workflow name is "Unit tests" and the job is "linux" running on ubuntu-latest
[FOUND] The final step is "make test-short" which is the key test command
[STEP] Reading the Makefile to understand test-short command
[FOUND] test-short adds -short -failfast to GO_FLAGS and calls test-filtered
[STEP] Reading Makefile fully to understand GOTEST and test-filtered
[FOUND] GOTEST = GOEXPERIMENT=synctest go test ./... with GO_FLAGS -short -failfast
[FOUND] The test runs ALL packages with -short -failfast flags
[STEP] Need to look at recent CI failures to identify which specific test(s) are flaky
[STEP] Checking git log for recent changes that might cause flakiness
[FOUND] Key failing tests identified from CI logs:
[FOUND] 1. TestEngineApiInvalidPayloadThenValidCanonicalFcuWithPayloadShouldSucceed - consistent failure - slotNumber missing
[FOUND] 2. TestUDPv4_LookupIterator - flaky/intermittent - unsolicited reply error
[FOUND] 3. TestUDPv5_findnodeCall - flaky/intermittent - wrong nodes in response
[FOUND] 4. TestEthSubscribeReceipts - already fixed in #19142
[STEP] Need to investigate each of these test failures. Starting with the most impactful ones.
[STEP] Reading execution/tests/engine_api_reorg_test.go for TestEngineApi... failure
[STEP] Reading execution/tests/engine_api_tester.go around line 243 to understand slotNumber issue
[FOUND] Line 285-287: EngineApiTester.Run() checks testing.Short() and SKIPS in short mode!
[FOUND] This means TestEngineApi... tests are SKIPPED during make test-short - they cannot be the flaky ones in ci.yml
[STEP] Re-evaluating: The ci.yml flaky tests must be something else that runs under -short mode
[STEP] Setting up git LFS and submodules as required
[STEP] Attempting to reproduce TestUDPv4_LookupIterator flakiness
[TEST] TestUDPv4_LookupIterator: PASS (27s!) - very slow test
[STEP] Now running TestUDPv5_findnodeCall
[TEST] TestUDPv5_findnodeCall: PASS quickly (0.02s)
[STEP] Need to run the tests in a loop to try to reproduce flakiness
[STEP] Running full p2p/discover tests in loop to catch flaky tests
[STEP] Running p2p/discover tests 5 times in a loop to try reproducing flakiness
[TEST] TestUDPv4_LookupIterator: All 5 runs PASS but timing varies 14-44 seconds
[STEP] Need to look at a broader picture - let me check what GitHub CI logs show as specific failures
[STEP] Searching for the "unsolicited reply" error in codebase
[FOUND] PRIMARY FLAKY TEST: TestEthSubscribeReceipts in rpc/jsonrpc - causes 6/7 recent failures!
[FOUND] The test hangs waiting on <-newReceipts channel, then times out after 10 minutes
[FOUND] SECONDARY FLAKY TEST: TestUDPv4_LookupIterator - unsolicited reply race condition
[STEP] Reading rpc/jsonrpc/eth_subscribe_test.go to analyze root cause
[FOUND] TestEthSubscribeReceipts hangs at line 106: receipts[i-1] = <-newReceipts
[FOUND] The channel newReceipts never receives data, causing indefinite blocking
[STEP] Need to look at SubscribeReceipts implementation and understand the notification flow
[FOUND] ROOT CAUSE of TestEthSubscribeReceipts hang:
[FOUND] Race between server-side receipt filter setup and block execution
[FOUND] ff.SubscribeReceipts() sends filter request through channel but does NOT wait for server to process it
[FOUND] When InsertChain runs, hasReceiptSubscriptions may still be false, causing all receipt notifications to be silently dropped
[FOUND] The fix requires synchronization to ensure server-side filter is active before inserting blocks
[STEP] Reading the relevant files to understand how to add synchronization
[STEP] Reading the Events.HasReceiptSubscriptions to understand the flag
[FIX] Plan: Add synchronization in TestEthSubscribeReceipts to wait for server-side receipt filter activation before InsertChain
[FIX] Will poll m.Notifications.Events.HasReceiptSubscriptions() after ff.SubscribeReceipts()
[STEP] Implementing the fix in rpc/jsonrpc/eth_subscribe_test.go
[STEP] Compiling and running TestEthSubscribeReceipts to verify fix
[TEST] TestEthSubscribeReceipts: PASS (0.07s) with fix applied
[STEP] Running TestEthSubscribeReceipts 10 times to verify fix stability
[TEST] TestEthSubscribeReceipts: All 10/10 runs PASS. Fix verified!
[DONE] TestEthSubscribeReceipts fix complete.
[STEP] Now investigating TestUDPv4_LookupIterator - secondary flaky test
[STEP] Looking at v4_lookup_test.go line 164 - which is actually in TestUDPv4_LookupIteratorClose
[FOUND] Root cause of TestUDPv4_LookupIterator: 500ms respTimeout can expire before pong is sent back under CI load
[FIX] serveTestnet calls packetInFrom(nil,...) for Pong but the reply matcher may have already timed out
[FIX] Will make serveTestnet tolerate errUnsolicitedReply on Pong responses
[STEP] Compiling and running TestUDPv4_LookupIterator with fix
[TEST] All TestUDPv4_Lookup* tests PASS with fix applied
[STEP] Now running TestUDPv4_LookupIterator in a loop for verification
[STEP] Running TestEthSubscribeReceipts 10 times and TestUDPv4_LookupIterator 5 times (takes 500ms and ~15-40s each)
[TEST] TestUDPv4_LookupIterator: All 5/5 runs PASS (timing: 24-74 seconds)
[STEP] Running both fixed test packages together to verify no regressions
[STEP] Verifying TestEthSubscribeReceipts 10 more times (already passed 10/10)
[TEST] TestUDPv4_LookupIterator: All 10/10 runs PASS! Fix verified.
[TEST] TestEthSubscribeReceipts: Previously verified 10/10 runs PASS.
[DONE] Both fixes verified with 10 successful runs each.
[STEP] Reviewing final state of all changes
[STEP] Running linter on changed files

=== SUMMARY ===

Flaky CI action: tests-linux (ubuntu-latest) - 50% failure rate (15/30 commits)
Workflow: ci.yml -> "Unit tests" job "linux" running make test-short

ROOT CAUSE 1 (Primary - 6/7 recent failures): TestEthSubscribeReceipts
  File: rpc/jsonrpc/eth_subscribe_test.go
  Bug: Race condition between server-side receipt filter activation and block execution.
  ff.SubscribeReceipts() sends a filter update request through a channel, but the
  server goroutine that processes it (setting hasReceiptSubscriptions=true) runs async.
  InsertChain() immediately follows and the execution pipeline checks
  HasReceiptSubscriptions() in NotifyReceipts(). If the flag is still false,
  all receipt notifications are silently dropped and the test hangs forever on
  <-newReceipts until the 10-minute timeout kills it.
  Fix: Added require.Eventually() poll that waits for
  m.Notifications.Events.HasReceiptSubscriptions() to return true before calling
  InsertChain. This ensures the server-side filter is fully activated.

ROOT CAUSE 2 (Secondary - 1/7 recent failures): TestUDPv4_LookupIterator
  File: p2p/discover/v4_lookup_test.go (serveTestnet function)
  Bug: Race condition with the 500ms respTimeout in the UDPv4 reply matcher.
  serveTestnet handles outgoing PINGs by immediately sending PONGs back via
  packetInFrom(nil, ...). Under CI load, goroutine scheduling can delay the
  serveTestnet goroutine enough that the 500ms reply matcher timeout fires before
  the PONG is delivered. The PONG then becomes "unsolicited" and handlePacket
  returns errUnsolicitedReply, which causes packetInFrom to fail (expected nil).
  Fix: Added packetInFromTolerate() helper that accepts an additional tolerated
  error. serveTestnet now uses this for Pong responses, allowing errUnsolicitedReply.
  A late Pong is harmless for lookup tests - the node will be re-pinged next round.

Files changed: 3
  rpc/jsonrpc/eth_subscribe_test.go - Added sync wait before InsertChain
  p2p/discover/v4_lookup_test.go - Changed Pong handling in serveTestnet
  p2p/discover/v4_udp_test.go - Added packetInFromTolerate helper method

Verification: Both fixes verified with 10 consecutive successful runs each.
[STEP] Final verification - checking modified files are consistent
