<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Multiple instances / One machine - Erigon 3 Docs</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Erigon 3 documentation!">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Erigon 3 Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/erigontech/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="multiple-instances--one-machine"><a class="header" href="#multiple-instances--one-machine">Multiple instances / One machine</a></h1>
<p>Erigon supports running multiple instances on the same machine by configuring distinct ports and data directories for each instance. Multiple instances are fully supported but require careful configuration to avoid port conflicts and resource contention. The modular architecture allows for flexible deployment patterns, from fully integrated instances to distributed service architectures. The primary consideration is the performance impact from shared disk access, especially during initial synchronization phases.</p>
<h2 id="required-configuration-flags"><a class="header" href="#required-configuration-flags">Required Configuration Flags</a></h2>
<p>To avoid conflicts between instances, you must define <strong>6 essential flags</strong> for each instance:</p>
<ul>
<li><code>--datadir</code> - Separate data directory for each instance</li>
<li><code>--port</code> - P2P networking port (default: <code>30303</code>)</li>
<li><code>--http.port</code> - HTTP JSON-RPC port (default: <code>8545</code>)</li>
<li><code>--authrpc.port</code> - Engine API port (default: <code>8551</code>)</li>
<li><code>--torrent.port</code> - BitTorrent protocol port (default: <code>42069</code>)</li>
<li><code>--private.api.addr</code> - Internal gRPC API address (default: <code>127.0.0.1:9090</code>)</li>
</ul>
<h2 id="example-configuration"><a class="header" href="#example-configuration">Example Configuration</a></h2>
<p>Here's how to run mainnet and sepolia instances simultaneously:</p>
<pre><code class="language-bash"># Mainnet instance
./build/bin/erigon \
  --datadir="&lt;your_mainnet_data_path&gt;" \
  --chain=mainnet \
  --port=30303 \
  --http.port=8545 \
  --authrpc.port=8551 \
  --torrent.port=42069 \
  --private.api.addr=127.0.0.1:9090 \
  --http --ws \
  --http.api=eth,debug,net,trace,web3,erigon

# Sepolia instance
./build/bin/erigon \
  --datadir="&lt;your_sepolia_data_path&gt;" \
  --chain=sepolia \
  --port=30304 \
  --http.port=8546 \
  --authrpc.port=8552 \
  --torrent.port=42068 \
  --private.api.addr=127.0.0.1:9091 \
  --http --ws \
  --http.api=eth,debug,net,trace,web3,erigon
</code></pre>
<h2 id="docker-compose-multi-instance-setup"><a class="header" href="#docker-compose-multi-instance-setup">Docker Compose Multi-Instance Setup</a></h2>
<p>For containerized deployments, the docker-compose configuration shows how services can be orchestrated with proper port isolation:</p>
<p>The compose file demonstrates the port allocation strategy:</p>
<ul>
<li><strong>9090-9094</strong>: Internal gRPC services (execution, sentry, consensus, downloader, txpool)</li>
<li><strong>8545, 8551</strong>: External HTTP APIs</li>
<li><strong>30303, 42069</strong>: P2P networking ports</li>
</ul>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="1-resource-management"><a class="header" href="#1-resource-management">1. Resource Management</a></h3>
<p><strong>Memory Considerations:</strong>
Erigon uses memory-mapped files (MDBX) where the OS manages page cache. Multiple instances will share the same page cache efficiently, but be aware that:</p>
<ul>
<li>Each instance uses ~4GB RAM during genesis sync and ~1GB during normal operation</li>
<li>OS page cache can utilize unlimited memory and is shared between instances</li>
<li>Memory usage shown by <code>htop</code> includes OS page cache and may appear inflated</li>
</ul>
<blockquote>
<p>⚠️ <strong>Disk Performance Warning:</strong> Multiple instances accessing the same disk concurrently will impact performance due to increased random disk access. This is particularly problematic during the "Blocks Execution stage" which performs many random reads. <strong>Avoid running multiple genesis syncs on the same disk.</strong></p>
</blockquote>
<h3 id="2-database-configuration"><a class="header" href="#2-database-configuration">2. Database Configuration</a></h3>
<p>For multiple instances, consider adjusting database parameters to reduce resource contention:</p>
<pre><code class="language-bash"># Reduce memory-mapped database growth to minimize disk churn
--db.growth.step=32MB
--db.size.limit=512MB
</code></pre>
<h3 id="3-network-port-management"><a class="header" href="#3-network-port-management">3. Network Port Management</a></h3>
<p><strong>Default Port Allocation:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Default Port</th><th>Protocol</th><th>Purpose</th></tr></thead><tbody>
<tr><td>Engine</td><td>9090</td><td>TCP</td><td>gRPC Server (Private)</td></tr>
<tr><td>Engine</td><td>42069</td><td>TCP/UDP</td><td>BitTorrent (Public)</td></tr>
<tr><td>Engine</td><td>8551</td><td>TCP</td><td>Engine API (Private)</td></tr>
<tr><td>Sentry</td><td>30303/30304</td><td>TCP/UDP</td><td>P2P Peering (Public)</td></tr>
<tr><td>RPCDaemon</td><td>8545</td><td>TCP</td><td>HTTP/WebSocket (Private)</td></tr>
</tbody></table>
</div>
<h3 id="4-service-separation"><a class="header" href="#4-service-separation">4. Service Separation</a></h3>
<p>Erigon supports modular deployment where components can run as separate processes:</p>
<p>For multiple instances, you can:</p>
<ul>
<li>Run each instance with integrated services (default)</li>
<li>Separate heavy components like <code>downloader</code> or <code>rpcdaemon</code> to dedicated processes</li>
<li>Use the <code>--private.api.addr</code> flag for inter-service communication</li>
</ul>
<h3 id="5-monitoring-and-logging"><a class="header" href="#5-monitoring-and-logging">5. Monitoring and Logging</a></h3>
<p>Configure separate log directories for each instance:</p>
<pre><code class="language-bash"># Instance 1
--log.dir.path=/logs/mainnet

# Instance 2  
--log.dir.path=/logs/sepolia
</code></pre>
<p>For Prometheus monitoring, each instance should expose metrics on different ports.</p>
<h2 id="performance-optimization"><a class="header" href="#performance-optimization">Performance Optimization</a></h2>
<h3 id="cloud-storage-considerations"><a class="header" href="#cloud-storage-considerations">Cloud Storage Considerations</a></h3>
<p>If using network-attached storage, apply these optimizations:</p>
<pre><code class="language-bash"># Reduce disk latency impact
export ERIGON_SNAPSHOT_MADV_RND=false
--db.pagesize=64kb

# For Polygon networks
--sync.loop.block.limit=10000
</code></pre>
<h3 id="memory-locking-for-performance"><a class="header" href="#memory-locking-for-performance">Memory Locking for Performance</a></h3>
<p>For production setups with sufficient RAM, you can lock critical data in memory:</p>
<pre><code class="language-bash"># Lock domain snapshots in RAM
vmtouch -vdlw /mnt/erigon/snapshots/domain/*bt
ls /mnt/erigon/snapshots/domain/*.kv | parallel vmtouch -vdlw
</code></pre>
<p><strong>File:</strong> README.md (L678-685)</p>
<pre><code class="language-markdown">vmtouch -vdlw /mnt/erigon/snapshots/domain/*bt
ls /mnt/erigon/snapshots/domain/*.kv | parallel vmtouch -vdlw
</code></pre>
<h1 id="if-it-failing-with-cant-allocate-memory-try"><a class="header" href="#if-it-failing-with-cant-allocate-memory-try">if it failing with "can't allocate memory", try:</a></h1>
<p>sync &amp;&amp; sudo sysctl vm.drop_caches=3
echo 1 &gt; /proc/sys/vm/compact_memory</p>
<pre><code></code></pre>
<p><strong>File:</strong> README.md (L769-774)</p>
<pre><code class="language-markdown">**Warning:** Multiple instances of Erigon on same machine will touch Disk concurrently, it impacts performance - one of
main Erigon optimizations: "reduce Disk random access".
"Blocks Execution stage" still does many random reads - this is reason why it's slowest stage. We do not recommend
running multiple genesis syncs on same Disk. If genesis sync passed, then it's fine to run multiple Erigon instances on
same Disk.

</code></pre>
<p><strong>File:</strong> README.md (L782-791)</p>
<pre><code class="language-markdown">What can do:

- reduce disk latency (not throughput, not iops)
    - use latency-critical cloud-drives
    - or attached-NVMe (at least for initial sync)
- increase RAM
- if you throw enough RAM, then can set env variable `ERIGON_SNAPSHOT_MADV_RND=false`
- Use `--db.pagesize=64kb` (less fragmentation, more IO)
- Or use Erigon3 (it also sensitive for disk-latency - but it will download 99% of history)

</code></pre>
<p><strong>File:</strong> docker-compose.yml (L9-12)</p>
<pre><code class="language-yaml"># Ports: `9090` execution engine (private api), `9091` sentry, `9092` consensus engine, `9093` snapshot downloader, `9094` TxPool
# Ports: `8545` json rpc, `8551` consensus json rpc, `30303` eth p2p protocol, `42069` bittorrent protocol,

# Connections: erigon -&gt; (sentries, downloader), rpcdaemon -&gt; (erigon, txpool), txpool -&gt; erigon
</code></pre>
<p><strong>File:</strong> docs/programmers_guide/db_faq.md (L34-42)</p>
<pre><code class="language-markdown">### How RAM used

Erigon will use all available RAM, but this RAM will not belong to Erigon’s process. OS will own all this
memory. And OS will maintain hot part of DB in RAM. If OS will need RAM for other programs or for second Erigon instance
OS will manage all the work. This called PageCache. Erigon itself using under 2Gb. So, Erigon will benefit from more
RAM and will use all RAM without re-configuration. Same PageCache can be used by other processes if they run on same
machine by just opening same DB file. For example if RPCDaemon started with —datadir option - it will open db of
Erigon and will use same PageCache (if data A already in RAM because it’s hot and RPCDaemon read it - then it read it
from RAM not from Disk). Shared memory.
</code></pre>
<p><strong>File:</strong> cmd/devnet/devnet/node.go (L190-194)</p>
<pre><code class="language-go">	// These are set to prevent disk and page size churn which can be excessive
	// when running multiple nodes
	// MdbxGrowthStep impacts disk usage, MdbxDBSizeLimit impacts page file usage
	n.nodeCfg.MdbxGrowthStep = 32 * datasize.MB
	n.nodeCfg.MdbxDBSizeLimit = 512 * datasize.MB
</code></pre>
<p><strong>File:</strong> tests/automated-testing/docker-compose.yml (L9-24)</p>
<pre><code class="language-yaml">      --datadir=/home/erigon/.local/share/erigon --chain=dev --private.api.addr=0.0.0.0:9090 --mine --log.dir.path=/logs/node1
    ports:
      - "8551:8551"
    volumes:
      - datadir:/home/erigon/.local/share/erigon
      - ./logdir:/logs
    user: ${DOCKER_UID}:${DOCKER_GID}
    restart: unless-stopped
    mem_swappiness: 0

  erigon-node2:
    profiles:
      - second
    image: erigontech/erigon:$ERIGON_TAG
    command: |
      --datadir=/home/erigon/.local/share/erigon --chain=dev --private.api.addr=0.0.0.0:9090 --staticpeers=$ENODE --log.dir.path=/logs/node2
</code></pre>
<p><strong>File:</strong> cmd/prometheus/prometheus.yml (L11-24)</p>
<pre><code class="language-yaml">      - targets:
          - erigon:6060 # If Erigon runned by default docker-compose, then it's available on `erigon` host.
          - erigon:6061
          - erigon:6062
          - 46.149.164.51:6060
          - host.docker.internal:6060 # this is how docker-for-mac allow to access host machine
          - host.docker.internal:6061
          - host.docker.internal:6062
          - 192.168.255.134:6060
          - 192.168.255.134:6061
          - 192.168.255.134:6062
          - 192.168.255.138:6060
          - 192.168.255.138:6061
          - 192.168.255.138:6062
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../fundamentals/modules/downloader.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../fundamentals/web3-wallet.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../fundamentals/modules/downloader.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../fundamentals/web3-wallet.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
