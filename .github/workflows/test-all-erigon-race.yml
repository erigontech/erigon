name: All tests (with -race)

on:
  push:
    branches:
      - 'release/**'
      - main
  pull_request:
    branches:
      - 'release/**'
  workflow_dispatch:

jobs:
  # 
  # This first job is used to determine if changes are within out-of-scope dirs or files (in such case the tests are not run because they would be meaningless)
  # NOTE: this logic is needed because the simple 'paths-ignore:' doesn't work since this workflow is set as a mandatory/required check for this repo
  # - '**/.github/workflows/**' is currently commented to avoid unintended freeze in case of concurrent changes outside the excluded paths (further development will be done in due course)
  # 
  source-of-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.filter.outputs.changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for changes within out-of-scope dirs or files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed_files:
              - 'dashboards/**'
              # - '**/.github/workflows/**'
              - '**/.github/workflows/backups-dashboards.yml'
  tests-linux:
    needs: source-of-changes
    timeout-minutes: 60
    concurrency:
      # concurrency group: there can be at most one running and one pending job in a 
      # concurrency group at any time. So for commits on main/release, we use different 
      # concurrency group per commit; for other branches, we use a branch-level CG.
      group: >-
        ${{
          (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) &&
          format('{0}-{1}-{2}-{3}', github.workflow, matrix.os, matrix.test-group, github.run_id) ||
          format('{0}-{1}-{2}-{3}', github.workflow, matrix.os, matrix.test-group, github.ref)
        }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
        test-group:
          - execution-spec
          - execution-heavy
          - execution-other
          - consensus
          - p2p-rpc
          - core-db
          - other
    runs-on: ${{ matrix.os }}

    steps:
      - name: Declare runners
        if: needs.source-of-changes.outputs.changed_files != 'true'
        run: |
          set +x
          echo "This workflow is being executed by this runner: $RUNNER_NAME"
          
      - name: "Checkout code with submodules and large files (lfs)"
        if: needs.source-of-changes.outputs.changed_files != 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: recursive
          lfs: true

      - name: Cleanup space
        run: |
          rm -fr /opt/az \
                 /opt/microsoft \
                 /usr/share/dotnet \
                 /usr/share/miniconda \
                 /usr/share/swift

      - name: Setup Go environment
        if: needs.source-of-changes.outputs.changed_files != 'true'
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: true
          
      - name: Install dependencies on Linux
        if: needs.source-of-changes.outputs.changed_files != 'true'
        run: sudo apt update -y && sudo apt install -y build-essential
        
      - name: Run ${{ matrix.test-group }} tests on ${{ matrix.os }}
        env:
          SKIP_FLAKY_TESTS: 'true'
          GODEBUG: cgocheck=0
          GOTRACEBACK: 1
          GOEXPERIMENT: synctest
          GOGC: 80
        if: needs.source-of-changes.outputs.changed_files != 'true'
        run: |
          case "${{ matrix.test-group }}" in
            execution-spec)
              # Heavy spec/state test suites from execution/tests (~32 min originally)
              # These run ethereum legacy tests, execution-spec tests and state tests
              go test -race -timeout 60m ./execution/tests -run "TestLegacyBlockchain|TestExecutionSpecBlockchain|TestExecutionSpecBlockchainDevnet|TestState$|TestStateCornerCases|TestRLP$|TestTransaction$|TestDifficulty$"
              ;;
            execution-heavy)
              # Remaining tests from execution/tests + heaviest execution subpackages
              # commitment (~264s), stagedsync (~241s), state (~84s), vm (~58s), engineapi (~55s)
              go test -race -timeout 60m ./execution/tests -run "^(?!TestLegacyBlockchain|TestExecutionSpecBlockchain|TestExecutionSpecBlockchainDevnet|TestState$|TestStateCornerCases$|TestRLP$|TestTransaction$|TestDifficulty$)"
              go test -race -timeout 60m ./execution/tests/blockgen/... ./execution/tests/mock/...
              go test -race -timeout 60m ./execution/commitment/... ./execution/stagedsync/... ./execution/state/...
              ;;
            execution-other)
              # All remaining execution subdirectories
              EXEC_HEAVY="execution/tests|execution/commitment|execution/stagedsync|execution/state"
              DIRS=$(ls -d -- execution/*/ | grep -vE "($EXEC_HEAVY)/" | sed 's/\/$//')
              for d in $DIRS; do
                if [ -d "$d" ]; then
                  TEST_PACKAGES=$(go list -f '{{if or .TestGoFiles .XTestGoFiles}}{{.ImportPath}}{{end}}' "./$d/..." 2>/dev/null)
                  if [ -n "$TEST_PACKAGES" ]; then
                    go test -race -timeout 30m "./$d/..."
                  fi
                fi
              done
              ;;
            consensus)
              go test -race -timeout 60m ./cl/...
              ;;
            p2p-rpc)
              go test -race -timeout 30m ./p2p/... ./rpc/...
              ;;
            core-db)
              go test -race -timeout 30m ./db/... ./node/... ./txnprovider/...
              ;;
            other)
              DIRS=$(ls -d -- */ | grep -vE '^(execution|cl|p2p|rpc|db|node|txnprovider|dashboards)/$' | sed 's/\/$//')
              for d in $DIRS; do
                if [ -d "$d" ]; then
                  TEST_PACKAGES=$(go list -f '{{if or .TestGoFiles .XTestGoFiles}}{{.ImportPath}}{{end}}' "./$d/...")
                  if [ -n "$TEST_PACKAGES" ]; then
                    go test -race -timeout 30m "./$d/..."
                  fi
                fi
              done
              ;;
          esac

      - name: This ${{ matrix.os }} check does not make sense for changes within out-of-scope directories
        if: needs.source-of-changes.outputs.changed_files == 'true'
        run: echo "This check does not make sense for changes within out-of-scope directories"
