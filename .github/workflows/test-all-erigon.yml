name: All tests

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    - cron: '20 16 * * *' # daily at 16:20 UTC ðŸ˜™ðŸ¤Œ
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  tests:
    concurrency:
      # concurrency group: there can be at most one running and one pending job in a
      # concurrency group at any time. So for commits on main/release, we use different
      # concurrency group per commit; for other branches, we use a branch-level CG.
      group: >-
        ${{
          (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) &&
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.run_id) ||
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.ref)
        }}
      cancel-in-progress: true
    strategy:
      matrix:
        os:
          - ubuntu-24.04
          - macos-15
    runs-on: ${{ matrix.os }}

    steps:
      - name: Declare runners
        run: |
          set +x
          echo "This workflow is being executed by this runner: $RUNNER_NAME"

      - name: Checkout custom actions
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - uses: ./.github/actions/setup-erigon
        id: erigon
        with:
          submodules: true
          lfs: tests

      - name: Run all tests on ${{ matrix.os }}
        env:
          SKIP_FLAKY_TESTS: 'true'
        run: make test-all

      - name: SonarCloud scan in case OS Linux
        if: runner.os == 'Linux'
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      - uses: ./.github/actions/cleanup-erigon
        if: always()


  tests-windows:
    concurrency:
      group: >-
        ${{
          (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) &&
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.run_id) ||
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.ref)
        }}
      cancel-in-progress: true
    strategy:
      matrix:
        os: [ windows-2025 ]
    runs-on:
      group: "selfhosted-win"

    steps:
      # not needed on self-hosted runner. already configured.
      #- name: Configure Pagefile
      #  uses: al-cheb/configure-pagefile-action@v1.5
      #  with:
      #    minimum-size: 8GB
      #    disk-root: "C:"

      - name: "Checkout code with submodules and large files (lfs) on ${{ matrix.os }}"
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: recursive
          lfs: true
          clean: true

      - name: Setup Go environment on ${{ matrix.os }}
        uses: actions/setup-go@v6
        with:
          go-version: '>=1.25'
          cache: false

      # "make" already preinstalled:
      #- name: Install make
      #  run: choco install make -y

      - name: Run all tests on ${{ matrix.os }}
        shell: bash
        env:
          GOMODCACHE: C:\go-cache\mod
          GOCACHE: C:\go-cache\build
        run: make test-all

      - name: Cleanup
        if: always()
        run: |
          Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
