name: All tests

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main 
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    - cron: '20 16 * * *' # daily at 16:20 UTC ðŸ˜™ðŸ¤Œ
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  # 
  # This first job is used to determine if changes are within out-of-scope dirs or files (in such case the tests are not run because they would be meaningless)
  # NOTE: this logic is needed because the simple 'paths-ignore:' doesn't work since this workflow is set as a mandatory/required check for this repo
  # - '**/.github/workflows/**' is currently commented to avoid unintended freeze in case of concurrent changes outside the excluded paths (further development will be done in due course)
  # 
  # TODO: This shouldn't be needed if caching works properly.
  source-of-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.filter.outputs.changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for changes within out-of-scope dirs or files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed_files:
              - 'dashboards/**'
              # - '**/.github/workflows/**'
              - '**/.github/workflows/backups-dashboards.yml'

  tests:
    needs: source-of-changes
    concurrency:
      # concurrency group: there can be at most one running and one pending job in a
      # concurrency group at any time. So for commits on main/release, we use different
      # concurrency group per commit; for other branches, we use a branch-level CG.
      group: >-
        ${{
          (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) &&
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.run_id) ||
          format('{0}-{1}-{2}', github.workflow, matrix.os, github.ref)
        }}
      cancel-in-progress: true
    strategy:
      matrix:
        os:
          - ubuntu-24.04
          - macos-15
          - windows-2025
    runs-on: ${{ matrix.os }}

    steps:
      - name: Configure Pagefile
        if: runner.os == 'Windows'
        uses: al-cheb/configure-pagefile-action@v1.5
        with:
          minimum-size: 8GB
          disk-root: "C:"

      - name: Declare runners
        if: needs.source-of-changes.outputs.changed_files != 'true'
        run: |
          set +x
          echo "This workflow is being executed by this runner: $RUNNER_NAME"

      - name: Checkout custom actions
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - if: needs.source-of-changes.outputs.changed_files != 'true'
        uses: ./.github/actions/setup-erigon
        id: erigon
        with:
          submodules: true
          lfs: tests

      - name: Run all tests on ${{ matrix.os }}
        if: needs.source-of-changes.outputs.changed_files != 'true'
        env:
          SKIP_FLAKY_TESTS: 'true'
        run: make test-all

      - uses: ./.github/actions/cleanup-erigon
        if: always()

      - name: This ${{ matrix.os }} check does not make sense for changes within out-of-scope directories
        if: needs.source-of-changes.outputs.changed_files == 'true'
        run: echo "This check does not make sense for changes within out-of-scope directories"
