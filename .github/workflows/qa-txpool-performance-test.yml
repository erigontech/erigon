name: QA - TxPool performance test

on:
  workflow_call:
  workflow_dispatch:
  # push:
  #   branches:
  #       - main
  #       - release/*
  #       - docker_pectra

jobs:
  tx_pool_assertoor_test:
    runs-on: [self-hosted, qa, long-running]
    env:
      ERIGON_QA_PATH: /home/qarunner/erigon-qa

    steps:
      - name: Fast checkout git repository
        uses: actions/checkout@v4

      # - name: Docker build current branch
      #   run: |
      #     docker build -t test/erigon:current .

      - name: Docker build noku-team/assertoor image
        run: |
          git clone https://github.com/noku-team/assertoor.git
          cd assertoor
          docker build -t test/assertoor:current .
          cd ..

      - name: Run self hosted Kurtosis + assertoor tests
        id: noku_kurtosis_test
        uses: noku-team/kurtosis-assertoor-github-action@v1
        with:
          enclave_name: "kurtosis-run1-${{ github.run_id }}"
          ethereum_package_args: ".github/workflows/kurtosis/txpool-assertoor.io"
          kurtosis_extra_args: --verbosity detailed --cli-log-level trace
          persistent_logs: "true"

      - name: Download kurtosis artifact
        uses: actions/github-script@v6
        if: always()
        continue-on-error: true
        env:
          WORKFLOW_FILENAME: qa-txpool-performance-test.yml
          ARTIFACT_NAME: enclave-dump-kurtosis-run1-${{ github.run_id }}
          ARTIFACT_FILENAME: enclave-dump-kurtosis-run1-${{ github.run_id }}.zip
          UNZIP_DIR: kurtosis_artifacts
        with:
          script: |
            const script = require('.github/workflows/scripts/download-previous-artifact.js')
            await script({github, context, core})

      - name: Parse Kurtosis output log and create JSON
        if: always()
        run: |
          # Find the folder starting with 'assertoor--'
          assertoor_folder=$(find kurtosis_artifacts -type d -name 'assertoor--*' | head -n 1)

          # Parse the output.log file within the assertoor-- folder
          output_log="${assertoor_folder}/output.log"
          echo "Parsing file: $output_log"

          # Create an empty JSON file if there are no results
          output_json="${{ github.workspace }}/outputs_kurtosis.json"
          echo "{}" > $output_json

          # Initialize an empty JSON object
          declare -A result_json

          # Parse the output.log file to find lines with msg="outputs_json"
          while IFS= read -r line; do
            if [[ "$line" == *'msg="outputs_json:'* ]]; then
              # Extract the JSON object and unescape the quotes
              json_str=$(echo "$line" | sed 's/.*msg="outputs_json: \(.*\)"/\1/' | sed 's/\\"/"/g')
              
              # Extract the task value from the JSON
              task=$(echo "$json_str" | jq -r '.task')
              
              # Skip if task is empty
              if [ -n "$task" ]; then
                # Initialize array for this task if it doesn't exist
                result_json[$task]="${result_json[$task]:-}"
                
                # Add comma separator if not the first entry
                if [ -n "${result_json[$task]}" ]; then
                  result_json[$task]="${result_json[$task]},"
                fi
                
                # Add the JSON object
                result_json[$task]="${result_json[$task]}$json_str"
              fi
            fi
          done < "$output_log"

          # Write the JSON object to the final file
          echo "{" > $output_json
          first_task=true
          for task in "${!result_json[@]}"; do
            # Add comma for all but first task
            if [ "$first_task" = true ]; then
              first_task=false
            else
              echo "," >> $output_json
            fi
            # Write the task array to the file
            echo "\"$task\": [${result_json[$task]}]" >> $output_json
          done
          echo "}" >> $output_json

      - name: Create HDR plots PNG artifacts
        if: always()
        run: |
          # Check if the JSON file exists
          output_json="${{ github.workspace }}/outputs_kurtosis.json"
          if [ ! -f "$output_json" ]; then
            echo "JSON file not found, skipping"
            exit 0
          fi

          # Check if tx_pool_latency_analysis array exists in the JSON
          if ! jq -e '.tx_pool_latency_analysis' "$output_json" > /dev/null 2>&1; then
            echo "tx_pool_latency_analysis array not found in JSON, skipping"
            exit 0
          fi

          # Get the array length
          array_length=$(jq '.tx_pool_latency_analysis | length' "$output_json")

          # Loop through each element in the array
          for ((i=0; i<array_length; i++)); do
            # Get tx_count for this element
            tx_count=$(jq -r ".tx_pool_latency_analysis[$i].tx_count" "$output_json")
            
            # Check if tx_pool_latency_hdr_plot exists for this element
            if jq -e ".tx_pool_latency_analysis[$i].tx_pool_latency_hdr_plot" "$output_json" > /dev/null 2>&1; then
              # Extract the plot data to a CSV file
              csv_file="tx_pool_latency_analysis_${i}_${tx_count}.csv"
              jq -r ".tx_pool_latency_analysis[$i].tx_pool_latency_hdr_plot" "$output_json" > "$csv_file"
              
              # Call the Python script to process the CSV file
              python3 $ERIGON_QA_PATH/test_system/qa-tests/uploads/upload_test_results.py \
                --input_file "$csv_file" \
                --output_file "tx_pool_latency_analysis_${i}_${tx_count}.png"
              
              # Delete the CSV file after processing
              rm -f "$csv_file"
              
              echo "Processed tx_pool_latency_analysis[$i] with tx_count=$tx_count"
            else
              echo "tx_pool_latency_hdr_plot not found for element $i, skipping"
            fi
          done

      - name: Upload PNG images as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tx-pool-latency-plots
          path: tx_pool_latency_analysis_*.png
          if-no-files-found: ignore

      - name: Clean up PNG files
        if: always()
        run: |
          # Remove all generated PNG files
          rm -f tx_pool_latency_analysis_*.png

      - name: Save test results
        if: always()
        env:
          TEST_RESULT: ${{ steps.noku_kurtosis_test.outputs.test_result || 'failure' }}
        run: |
          python3 $ERIGON_QA_PATH/test_system/qa-tests/uploads/upload_test_results.py \
            --repo erigon \
            --commit $(git rev-parse HEAD) \
            --branch ${{ github.ref_name }} \
            --test_name txpool-performance \
            --runner ${{ runner.name }} \
            --outcome $TEST_RESULT \
            --result_file ${{ github.workspace }}/outputs_kurtosis.json

      # Clean up, always
      - name: Clean test results
        if: always()
        run: |
          rm -rf kurtosis_artifacts
          rm -rf outputs_kurtosis.json

      - name: Clean docker containers and images
        if: always()
        run: |
          # stop all containers
          docker stop $(docker ps -a -q)
          # remove containers and images
          docker rm -f $(docker ps -a -q)
          docker rmi -f $(docker images -q)
          docker system prune -a -f
          docker volume rm $(docker volume ls -q)
