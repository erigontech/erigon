name: Test Hive

on:
  push:
    branches:
        - main
        - release/*
        - docker_pectra
  schedule:
    - cron: "0 05 * * *" # daily at 5 am UTC
  workflow_dispatch:

  
jobs:
  test-hive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hive
        uses: actions/checkout@v4
        with:
          repository: somnathb1/hive
          ref: main
          path: hive
      - name: Setup go env and cache
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.22'
          go-version-file: 'hive/go.mod'
      - name: Get dependencies and build hive
        run: |
          cd hive
          go get .
          rm clients/erigon/Dockerfile
          mv clients/erigon/Dockerfile.git clients/erigon/Dockerfile
          go build .

      # Depends on the last line of hive output that prints the number of suites, tests and failed
      # Currently, we fail even if suites and tests are too few, indicating the tests did not run
      # We also fail if more than half the tests fail
      - name: Run hive and parse output
        run: |
          cd hive
          go build .
          ./hive --sim ethereum/engine --client erigon --results-root=/results-${{ github.run_id }} &> output.log
          tail -100 output.log
          last_line=$(tail -1 output.log | sed -r "s/\x1B\[[0-9;]*[a-zA-Z]//g")
          suites=$(echo "$last_line" | sed -n 's/.*suites=\([0-9]*\).*/\1/p')
          tests=$(echo "$last_line" | sed -n 's/.*tests=\([0-9]*\).*/\1/p')
          failed=$(echo "$last_line" | sed -n 's/.*failed=\([0-9]*\).*/\1/p')
          echo "Suites: $suites, Tests: $tests, Failed: $failed"
          if (( suites < 20 || tests < 20))
            exit 1
          if (( 2 * failed > tests ))
            exit 1
