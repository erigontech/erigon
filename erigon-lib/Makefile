GOBINREL = build/bin
export GOBIN = $(CURDIR)/$(GOBINREL)

CGO_CXXFLAGS ?= $(shell go env CGO_CXXFLAGS 2>/dev/null)
ifeq ($(CGO_CXXFLAGS),)
	CGO_CXXFLAGS += -g
	CGO_CXXFLAGS += -O2
endif

GOINSTALL = CGO_CXXFLAGS="$(CGO_CXXFLAGS)" go install -trimpath
GOTEST = CGO_CXXFLAGS="$(CGO_CXXFLAGS)" go test -trimpath

OS = $(shell uname -s)
ARCH = $(shell uname -m)

ifeq ($(OS),Darwin)
PROTOC_OS := osx
ifeq ($(ARCH),arm64)
ARCH = aarch_64
endif
endif
ifeq ($(OS),Linux)
PROTOC_OS = linux
endif

PROTOC_INCLUDE = build/include/google
PROTO_PATH = interfaces

default: gen

gen: grpc mocks

$(GOBINREL):
	mkdir -p "$(GOBIN)"

$(GOBINREL)/protoc: | $(GOBINREL)
	$(eval PROTOC_TMP := $(shell mktemp -d))
	curl -sSL https://github.com/protocolbuffers/protobuf/releases/download/v31.1/protoc-31.1-$(PROTOC_OS)-$(ARCH).zip -o "$(PROTOC_TMP)/protoc.zip"
	cd "$(PROTOC_TMP)" && unzip protoc.zip
	cp "$(PROTOC_TMP)/bin/protoc" "$(GOBIN)"
	mkdir -p "$(PROTOC_INCLUDE)"
	cp -R "$(PROTOC_TMP)/include/google/" "$(PROTOC_INCLUDE)"
	rm -rf "$(PROTOC_TMP)"

# 'protoc-gen-go' tool generates proto messages
$(GOBINREL)/protoc-gen-go: | $(GOBINREL)
	$(GOINSTALL) google.golang.org/protobuf/cmd/protoc-gen-go

# 'protoc-gen-go-grpc' tool generates grpc services
$(GOBINREL)/protoc-gen-go-grpc: | $(GOBINREL)
	$(GOINSTALL) google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

$(PROTO_PATH):
	git submodule update --init $@

protoc-all: $(GOBINREL)/protoc $(PROTOC_INCLUDE) $(GOBINREL)/protoc-gen-go $(GOBINREL)/protoc-gen-go-grpc

protoc-clean:
	rm -f "$(GOBIN)/protoc"*
	rm -rf "$(PROTOC_INCLUDE)"

grpc: protoc-all $(PROTO_PATH)
	PATH="$(GOBIN):$(PATH)" protoc --proto_path=$(PROTO_PATH) --go_out=gointerfaces -I=$(PROTOC_INCLUDE) \
		--go_opt=Mtypes/types.proto=./typesproto \
		types/types.proto
	PATH="$(GOBIN):$(PATH)" protoc --proto_path=$(PROTO_PATH) --go_out=gointerfaces --go-grpc_out=gointerfaces -I=$(PROTOC_INCLUDE) \
		--go_opt=Mtypes/types.proto=github.com/erigontech/erigon-lib/gointerfaces/typesproto \
		--go-grpc_opt=Mtypes/types.proto=github.com/erigontech/erigon-lib/gointerfaces/typesproto \
		--go_opt=Mp2psentry/sentry.proto=./sentryproto \
		--go-grpc_opt=Mp2psentry/sentry.proto=./sentryproto \
		--go_opt=Mp2psentinel/sentinel.proto=./sentinelproto \
		--go-grpc_opt=Mp2psentinel/sentinel.proto=./sentinelproto \
		--go_opt=Mremote/kv.proto=./remoteproto \
		--go-grpc_opt=Mremote/kv.proto=./remoteproto \
		--go_opt=Mremote/ethbackend.proto=./remoteproto \
		--go-grpc_opt=Mremote/ethbackend.proto=./remoteproto \
		--go_opt=Mremote/bor.proto=./remoteproto \
		--go-grpc_opt=Mremote/bor.proto=./remoteproto \
		--go_opt=Mdownloader/downloader.proto=./downloaderproto \
		--go-grpc_opt=Mdownloader/downloader.proto=./downloaderproto \
		--go_opt=Mexecution/execution.proto=./executionproto \
		--go-grpc_opt=Mexecution/execution.proto=./executionproto \
		--go_opt=Mtxpool/txpool.proto=./txpoolproto \
		--go-grpc_opt=Mtxpool/txpool.proto=./txpoolproto \
		--go_opt=Mtxpool/mining.proto=./txpoolproto \
		--go-grpc_opt=Mtxpool/mining.proto=./txpoolproto \
		p2psentry/sentry.proto p2psentinel/sentinel.proto \
		remote/bor.proto remote/kv.proto remote/ethbackend.proto \
		downloader/downloader.proto execution/execution.proto \
		txpool/txpool.proto txpool/mining.proto

mocks:
	rm -f $(GOBIN)/mockgen
	$(GOINSTALL) go.uber.org/mock/mockgen@latest
	grep -r -l --exclude-dir="*$(GOBINREL)*" "^// Code generated by MockGen. DO NOT EDIT.$$" . | xargs rm -r
	PATH="$(GOBIN):$(PATH)" go generate -run "mockgen" ./...

lintci-deps:
	@./tools/golangci_lint.sh --install-deps
lintci:
	@CGO_CXXFLAGS="$(CGO_CXXFLAGS)" ./tools/golangci_lint.sh

lint-mod-tidy:
	@./tools/mod_tidy_check.sh

lint-deps: lintci-deps
lint: lintci lint-mod-tidy

test-short:
	$(GOTEST) -short ./...

test-all:
	$(GOTEST) -coverprofile=coverage-test-all.out ./...

test-all-race:
	$(GOTEST) -race ./...
